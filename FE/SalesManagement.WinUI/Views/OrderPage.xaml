<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="SalesManagement.WinUI.Views.OrderPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls"
    xmlns:viewmodels="using:SalesManagement.WinUI.ViewModels"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Page.Resources>
        <Style x:Key="StatCardStyle" TargetType="Border">
            <Setter Property="Background" Value="{ThemeResource LayerFillColorDefaultBrush}"/>
            <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefaultBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20,16"/>
            <Setter Property="Width" Value="300"/>
            <Setter Property="Height" Value="100"/>
            <Setter Property="Margin" Value="0,0,16,16"/>
        </Style>
    </Page.Resources>

    <Grid>
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <Grid Padding="40,32" RowSpacing="24">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <RelativePanel Grid.Row="0">
                    <StackPanel Spacing="4" RelativePanel.AlignLeftWithPanel="True">
                        <TextBlock Text="Quản lý đơn hàng" FontSize="28" FontWeight="SemiBold" FontFamily="Segoe UI Variable Display"/>
                        <TextBlock Text="Quản lý, tạo và theo dõi các đơn hàng của bạn" Foreground="{ThemeResource SystemControlPageTextBaseMediumBrush}"/>
                    </StackPanel>
                    <Button Content="+ Tạo đơn hàng mới" Style="{StaticResource AccentButtonStyle}"
                            Command="{x:Bind ViewModel.CreateNewOrderCommand}"
                            RelativePanel.AlignRightWithPanel="True" RelativePanel.AlignVerticalCenterWithPanel="True"/>
                </RelativePanel>

                <VariableSizedWrapGrid Grid.Row="1" Orientation="Horizontal"
                                       ItemWidth="316" ItemHeight="116"
                                       MaximumRowsOrColumns="4">

                    <Border Style="{StaticResource StatCardStyle}">
                        <StackPanel Spacing="4" VerticalAlignment="Center">
                            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                <FontIcon Glyph="&#xE7BF;" FontSize="14" Foreground="{ThemeResource SystemControlPageTextBaseMediumBrush}"/>
                                <TextBlock Text="Tổng đơn hàng" Foreground="{ThemeResource SystemControlPageTextBaseMediumBrush}" FontSize="13" VerticalAlignment="Center"/>
                            </StackPanel>
                            <TextBlock Text="{x:Bind ViewModel.TotalOrdersCount, Mode=OneWay}" FontSize="28" FontWeight="Bold"/>
                        </StackPanel>
                    </Border>

                    <Border Style="{StaticResource StatCardStyle}">
                        <StackPanel Spacing="4" VerticalAlignment="Center">
                            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                <FontIcon Glyph="&#xE8C7;" FontSize="14" Foreground="{ThemeResource SystemControlPageTextBaseMediumBrush}"/>
                                <TextBlock Text="Tổng doanh thu" Foreground="{ThemeResource SystemControlPageTextBaseMediumBrush}" FontSize="13" VerticalAlignment="Center"/>
                            </StackPanel>
                            <TextBlock Text="{x:Bind ViewModel.TotalRevenueDisplay, Mode=OneWay}" FontSize="28" FontWeight="Bold"/>
                        </StackPanel>
                    </Border>

                    <Border Grid.Column="2" Style="{StaticResource StatCardStyle}">
                        <StackPanel Spacing="4">
                            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                <FontIcon Glyph="&#xE930;"
                                          FontSize="14"
                                          Foreground="{ThemeResource SystemControlPageTextBaseMediumBrush}"/>
                                <TextBlock Text="Đơn mới tạo"
                                           Foreground="{ThemeResource SystemControlPageTextBaseMediumBrush}"
                                           FontSize="13"
                                           VerticalAlignment="Center"/>
                            </StackPanel>

                            <TextBlock Text="{x:Bind ViewModel.PendingOrdersCount, Mode=OneWay}"
                                       FontSize="28" FontWeight="Bold" />
                        </StackPanel>
                    </Border>

                </VariableSizedWrapGrid>

                <Border Grid.Row="2" Background="{ThemeResource LayerFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="8">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Grid Grid.Row="0" Padding="20,20,20,16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <VariableSizedWrapGrid Grid.Column="0" Orientation="Horizontal"
                                                   ItemHeight="60" ItemWidth="180" MaximumRowsOrColumns="4">

                                <StackPanel Margin="0,0,12,0">
                                    <TextBlock Text="Trạng thái" FontSize="12" Margin="0,0,0,4" FontWeight="Medium"/>
                                    <ComboBox PlaceholderText="Tất cả" HorizontalAlignment="Stretch" MinWidth="160"
                                              ItemsSource="{x:Bind ViewModel.StatusFilters}"
                                              SelectedItem="{x:Bind ViewModel.SelectedStatusFilter, Mode=TwoWay}"/>
                                </StackPanel>

                                <StackPanel Margin="0,0,12,0">
                                    <TextBlock Text="Từ ngày" FontSize="12" Margin="0,0,0,4" FontWeight="Medium"/>
                                    <CalendarDatePicker PlaceholderText="Chọn ngày" HorizontalAlignment="Stretch" MinWidth="160"
                                                        Date="{x:Bind ViewModel.FilterFromDate, Mode=TwoWay}"/>
                                </StackPanel>

                                <StackPanel Margin="0,0,12,0">
                                    <TextBlock Text="Đến ngày" FontSize="12" Margin="0,0,0,4" FontWeight="Medium"/>
                                    <CalendarDatePicker PlaceholderText="Chọn ngày" HorizontalAlignment="Stretch" MinWidth="160"
                                                        Date="{x:Bind ViewModel.FilterToDate, Mode=TwoWay}"/>
                                </StackPanel>
                            </VariableSizedWrapGrid>

                            <Button Grid.Column="1" Content="Xóa bộ lọc" VerticalAlignment="Bottom" Margin="8,0,0,2"
                                    Command="{x:Bind ViewModel.ClearFilterCommand}"/>
                        </Grid>

                        <controls:DataGrid Grid.Row="1" x:Name="OrderGrid"
                                           ItemsSource="{x:Bind ViewModel.DisplayOrders, Mode=OneWay}"
                                           SelectedItem="{x:Bind ViewModel.SelectedOrder, Mode=TwoWay}"
                                           SelectionChanged="OrderGrid_SelectionChanged"
                                           AutoGenerateColumns="False"
                                           GridLinesVisibility="Horizontal"
                                           RowHeight="52"
                                           BorderThickness="0,1"
                                           BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                           HorizontalScrollBarVisibility="Disabled">
                            <controls:DataGrid.Resources>
                                <SolidColorBrush x:Key="DataGridCellFocusVisualPrimaryBrush" Color="Transparent"/>
                                <SolidColorBrush x:Key="DataGridCellFocusVisualSecondaryBrush" Color="Transparent"/>
                                <SolidColorBrush x:Key="SystemControlHighlightListAccentLowBrush" Color="#E6F2FF" />
                                <SolidColorBrush x:Key="SystemControlHighlightListLowBrush" Color="#D9EBFF" />
                                <SolidColorBrush x:Key="SystemControlHighlightAltBaseHighBrush" Color="Black"/>
                                <SolidColorBrush x:Key="DataGridRowSelectedBackgroundBrush" Color="#E6F2FF" />
                                <SolidColorBrush x:Key="DataGridRowSelectedHoverBackgroundBrush" Color="#D9EBFF" />
                                <SolidColorBrush x:Key="DataGridRowSelectedUnfocusedBackgroundBrush" Color="#F0F7FF" />
                                <SolidColorBrush x:Key="DataGridRowSelectedForegroundBrush" Color="Black" />
                            </controls:DataGrid.Resources>
                            <controls:DataGrid.Columns>
                                <controls:DataGridTextColumn Header="Mã đơn" Binding="{Binding OrderId}" Width="*"/>
                                <controls:DataGridTextColumn Header="Ngày tạo" Binding="{Binding DateDisplay}" Width="*"/>
                                <controls:DataGridTextColumn Header="Số lượng" Binding="{Binding ItemsCountDisplay}" Width="*"/>
                                <controls:DataGridTextColumn Header="Tổng tiền" Binding="{Binding AmountDisplay}" Width="*"/>

                                <controls:DataGridTemplateColumn Header="Trạng thái" Width="160">
                                    <controls:DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate x:DataType="viewmodels:OrderItemViewModel">
                                            <Border Width="100" Height="24" CornerRadius="12"
                                                    Background="{x:Bind StatusColor}"
                                                    BorderBrush="{x:Bind StatusBorder}"
                                                    BorderThickness="1" HorizontalAlignment="Center" VerticalAlignment="Center">
                                                <TextBlock Text="{x:Bind Status}" FontSize="11" FontWeight="SemiBold"
                                                           Foreground="{x:Bind StatusBorder}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                        </DataTemplate>
                                    </controls:DataGridTemplateColumn.CellTemplate>
                                </controls:DataGridTemplateColumn>

                                <controls:DataGridTemplateColumn Header="Thao tác" Width="120">
                                    <controls:DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate x:DataType="viewmodels:OrderItemViewModel">
                                            <StackPanel Orientation="Horizontal" Spacing="16" VerticalAlignment="Center" HorizontalAlignment="Center">
                                                <Button Padding="4" Background="Transparent" BorderThickness="0"
                                                        Command="{x:Bind EditCommand }">
                                                    <FontIcon Glyph="&#xE70F;" FontSize="14" Foreground="{ThemeResource SystemControlPageTextBaseMediumBrush}"/>
                                                </Button>
                                                <Button Padding="4" Background="Transparent" BorderThickness="0"
                                                        Command="{x:Bind DeleteCommand}">
                                                    <FontIcon Glyph="&#xE74D;" FontSize="14" Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                                                </Button>
                                            </StackPanel>
                                        </DataTemplate>
                                    </controls:DataGridTemplateColumn.CellTemplate>
                                </controls:DataGridTemplateColumn>
                            </controls:DataGrid.Columns>
                        </controls:DataGrid>

                        <RelativePanel Grid.Row="2" Padding="20,16">
                            <TextBlock Text="{x:Bind ViewModel.PaginationStatusText, Mode=OneWay}"
                                       Foreground="{ThemeResource SystemControlPageTextBaseMediumBrush}"
                                       RelativePanel.AlignVerticalCenterWithPanel="True"/>

                            <StackPanel Orientation="Horizontal" Spacing="8" RelativePanel.AlignRightWithPanel="True">
                                <Button Content="Trước" Command="{x:Bind ViewModel.PreviousPageCommand}" IsEnabled="{x:Bind ViewModel.CanGoPrevious, Mode=OneWay}"/>
                                <Button Content="{x:Bind ViewModel.CurrentPage, Mode=OneWay}"
                                        Background="{ThemeResource SystemAccentColor}"
                                        Foreground="White" Width="36"/>
                                <Button Content="Sau" Command="{x:Bind ViewModel.NextPageCommand}" IsEnabled="{x:Bind ViewModel.CanGoNext, Mode=OneWay}"/>
                            </StackPanel>
                        </RelativePanel>
                    </Grid>
                </Border>
            </Grid>
        </ScrollViewer>

        <ProgressRing IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                      Width="60" Height="60"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center"/>
    </Grid>
</Page>