<Page
    x:Class="SalesManagement.WinUI.Views.PromotionPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:SalesManagement.WinUI.Models">

    <Grid Padding="24" RowSpacing="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup>
                <!-- Desktop: > 1200px -->
                <VisualState x:Name="WideLayout">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1200" />
                    </VisualState.StateTriggers>
                </VisualState>

                <!-- Tablet: 768px - 1199px -->
                <VisualState x:Name="MediumLayout">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="768" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="ContentGrid.ColumnSpacing" Value="16" />
                        <Setter Target="Col1.Width" Value="1.5*" />
                        <Setter Target="Col2.Width" Value="1.5*" />
                        <Setter Target="Col3.Width" Value="1.2*" />
                        <Setter Target="ActionStack.Spacing" Value="8" />
                        <Setter Target="EditBtn.Width" Value="110" />
                    </VisualState.Setters>
                </VisualState>

                <!-- Mobile: < 768px -->
                <VisualState x:Name="NarrowLayout">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="ContentGrid.RowSpacing" Value="12" />
                        <Setter Target="ContentGrid.ColumnSpacing" Value="0" />
                        <Setter Target="Col1.Width" Value="*" />
                        <Setter Target="Col2.Width" Value="0" />
                        <Setter Target="Col3.Width" Value="0" />
                        <Setter Target="Col4.Width" Value="0" />
                        <Setter Target="InfoStack.Orientation" Value="Vertical" />
                        <Setter Target="DiscountStack.Visibility" Value="Collapsed" />
                        <Setter Target="TimeStack.Visibility" Value="Collapsed" />
                        <Setter Target="ActionStack.Visibility" Value="Collapsed" />
                        <Setter Target="MobileLayout.Visibility" Value="Visible" />
                        <Setter Target="HeaderText.FontSize" Value="24" />
                        <Setter Target="AddButton.Padding" Value="12,6" />
                        <Setter Target="MainGrid.Padding" Value="16" />
                        <Setter Target="MainGrid.RowSpacing" Value="16" />
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <!-- ================= HEADER ================= -->
        <Grid Grid.Row="0" ColumnSpacing="16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel Spacing="4">
                <TextBlock
                    x:Name="HeaderText"
                    Text="Quản lý khuyến mãi"
                    FontSize="32"
                    FontWeight="Bold"
                    VerticalAlignment="Center" />
                <TextBlock
                    Text="Tạo và quản lý các chương trình khuyến mãi"
                    FontSize="14"
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    VerticalAlignment="Center" />
            </StackPanel>

            <Button
                x:Name="AddButton"
                Grid.Column="1"
                Content="+ Thêm khuyến mãi"
                Padding="16,8"
                CornerRadius="8"
                FontWeight="SemiBold"
                FontSize="14"
                Background="{ThemeResource AccentFillColorDefaultBrush}"
                Foreground="White"
                Click="AddButton_Click">
                <Button.Shadow>
                    <ThemeShadow />
                </Button.Shadow>
            </Button>
        </Grid>

        <!-- ================= LIST PROMOTION ================= -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <ListView
                ItemsSource="{Binding Promotions}"
                SelectionMode="None"
                HorizontalContentAlignment="Stretch"
                Padding="0"
                Margin="0">

                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="models:PromotionResponse">

                        <Border
                            Margin="0,8"
                            Padding="20"
                            CornerRadius="12"
                            BorderThickness="1"
                            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">

                            <Border.Shadow>
                                <ThemeShadow />
                            </Border.Shadow>

                            <Grid>
                                <!-- Layout Desktop/Tablet -->
                                <Grid x:Name="ContentGrid" ColumnSpacing="24">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition x:Name="Col1" Width="2*" MinWidth="200" />
                                        <ColumnDefinition x:Name="Col2" Width="1.2*" MinWidth="140" />
                                        <ColumnDefinition x:Name="Col3" Width="1.5*" MinWidth="180" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition x:Name="Col4" Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <!-- ===== CỘT 1: THÔNG TIN ===== -->
                                    <StackPanel x:Name="InfoStack" Spacing="8">
                                        <TextBlock
                                            Text="{Binding PromotionName}"
                                            FontSize="18"
                                            FontWeight="Bold"
                                            TextTrimming="CharacterEllipsis" />

                                        <Border
                                            Padding="8,4"
                                            CornerRadius="6"
                                            HorizontalAlignment="Left"
                                            Background="{ThemeResource SubtleFillColorSecondaryBrush}">
                                            <TextBlock
                                                Text="{Binding PromotionCode}"
                                                FontSize="12"
                                                FontWeight="SemiBold"
                                                FontFamily="Consolas"
                                                Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                                        </Border>

                                        <TextBlock
                                            Text="{Binding Description}"
                                            TextWrapping="Wrap"
                                            MaxLines="2"
                                            FontSize="14"
                                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                            LineHeight="20" />
                                    </StackPanel>

                                    <!-- ===== CỘT 2: GIẢM GIÁ ===== -->
                                    <Border
                                        x:Name="DiscountStack"
                                        Grid.Column="1"
                                        Padding="16,12"
                                        CornerRadius="10"
                                        Background="{ThemeResource LayerFillColorDefaultBrush}">
                                        <StackPanel Spacing="6">
                                            <TextBlock
                                                Text="GIẢM GIÁ"
                                                FontSize="11"
                                                FontWeight="Bold"
                                                Foreground="{ThemeResource TextFillColorTertiaryBrush}" />

                                            <TextBlock
                                                Text="{Binding FormattedDiscount}"
                                                FontSize="22"
                                                FontWeight="Bold"
                                                Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />

                                            <TextBlock
                                                Text="{Binding FormattedDiscountRange}"
                                                FontSize="12"
                                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                TextWrapping="Wrap"
                                                LineHeight="18" />
                                        </StackPanel>
                                    </Border>

                                    <!-- ===== CỘT 3: THỜI GIAN ===== -->
                                    <StackPanel x:Name="TimeStack" Grid.Column="2" Spacing="10">
                                        <!-- Badge trạng thái -->
                                        <Border
                                            Padding="12,6"
                                            CornerRadius="16"
                                            HorizontalAlignment="Left"
                                            Background="{Binding StatusBrush}">
                                            <TextBlock
                                                Text="{Binding StatusText}"
                                                Foreground="White"
                                                FontSize="12"
                                                FontWeight="Bold" />
                                        </Border>

                                        <StackPanel Spacing="8">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <FontIcon
                                                    Glyph="&#xE787;"
                                                    FontSize="14"
                                                    Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                                <TextBlock
                                                    Text="{Binding FormattedDateRange}"
                                                    FontSize="13"
                                                    TextWrapping="Wrap"
                                                    LineHeight="18" />
                                            </StackPanel>

                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <FontIcon
                                                    Glyph="&#xE8EF;"
                                                    FontSize="14"
                                                    Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                                <TextBlock FontSize="13">
                                                    <Run Text="Đã dùng:" />
                                                    <Run Text="{Binding UsedCount}" FontWeight="SemiBold" />
                                                    <Run Text="/" />
                                                    <Run Text="{Binding UsageLimit}" FontWeight="SemiBold" />
                                                </TextBlock>
                                            </StackPanel>
                                        </StackPanel>
                                    </StackPanel>

                                    <!-- ===== CỘT 4: ACTION ===== -->
                                    <StackPanel
                                        x:Name="ActionStack"
                                        Grid.Column="4"
                                        VerticalAlignment="Center"
                                        Spacing="10">

                                        <Button
                                            x:Name="EditBtn"
                                            Content="Chỉnh sửa"
                                            Width="140"
                                            Padding="12,8"
                                            CornerRadius="8"
                                            FontWeight="SemiBold"
                                            HorizontalAlignment="Stretch"
                                            Click="EditPromotion_Click">
                                            <Button.Resources>
                                                <SolidColorBrush x:Key="ButtonBackground" Color="Transparent"/>
                                                <SolidColorBrush x:Key="ButtonBackgroundPointerOver" Color="#0A000000"/>
                                            </Button.Resources>
                                        </Button>

                                        <Button
                                            x:Name="CancelBtn"
                                            Content="Hủy khuyến mãi"
                                            Width="140"
                                            Padding="12,8"
                                            CornerRadius="8"
                                            FontWeight="SemiBold"
                                            Background="#FFE74C3C"
                                            Foreground="White"
                                            HorizontalAlignment="Stretch"
                                            Click="CancelPromotion_Click"
                                            Visibility="{x:Bind statusBool, Mode=OneWay}">
                                            <Button.Resources>
                                                <SolidColorBrush x:Key="ButtonBackgroundPointerOver" Color="#FFC0392B"/>
                                                <SolidColorBrush x:Key="ButtonBackgroundPressed" Color="#FFA93226"/>
                                            </Button.Resources>
                                        </Button>
                                    </StackPanel>
                                </Grid>

                                <!-- Layout Mobile (Collapsed by default) -->
                                <StackPanel x:Name="MobileLayout" Spacing="16" Visibility="Collapsed">
                                    <!-- Header với status badge -->
                                    <Grid>
                                        <StackPanel Spacing="6">
                                            <TextBlock
                                                Text="{Binding PromotionName}"
                                                FontSize="18"
                                                FontWeight="Bold"
                                                TextWrapping="Wrap" />

                                            <Border
                                                Padding="8,4"
                                                CornerRadius="6"
                                                HorizontalAlignment="Left"
                                                Background="{ThemeResource SubtleFillColorSecondaryBrush}">
                                                <TextBlock
                                                    Text="{Binding PromotionCode}"
                                                    FontSize="11"
                                                    FontWeight="SemiBold"
                                                    FontFamily="Consolas"
                                                    Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                                            </Border>
                                        </StackPanel>

                                        <Border
                                            Padding="10,5"
                                            CornerRadius="14"
                                            HorizontalAlignment="Right"
                                            VerticalAlignment="Top"
                                            Background="{Binding StatusBrush}">
                                            <TextBlock
                                                Text="{Binding StatusText}"
                                                Foreground="White"
                                                FontSize="11"
                                                FontWeight="Bold" />
                                        </Border>
                                    </Grid>

                                    <!-- Description -->
                                    <TextBlock
                                        Text="{Binding Description}"
                                        TextWrapping="Wrap"
                                        MaxLines="3"
                                        FontSize="14"
                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                        LineHeight="20" />

                                    <!-- Info Grid -->
                                    <Grid ColumnSpacing="12">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition />
                                            <ColumnDefinition />
                                        </Grid.ColumnDefinitions>

                                        <!-- Discount -->
                                        <Border
                                            Padding="12,10"
                                            CornerRadius="8"
                                            Background="{ThemeResource LayerFillColorDefaultBrush}">
                                            <StackPanel Spacing="4">
                                                <TextBlock
                                                    Text="GIẢM GIÁ"
                                                    FontSize="10"
                                                    FontWeight="Bold"
                                                    Foreground="{ThemeResource TextFillColorTertiaryBrush}" />
                                                <TextBlock
                                                    Text="{Binding FormattedDiscount}"
                                                    FontSize="18"
                                                    FontWeight="Bold"
                                                    Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                                                <TextBlock
                                                    Text="{Binding FormattedDiscountRange}"
                                                    FontSize="11"
                                                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                    TextWrapping="Wrap" />
                                            </StackPanel>
                                        </Border>

                                        <!-- Usage -->
                                        <Border
                                            Grid.Column="1"
                                            Padding="12,10"
                                            CornerRadius="8"
                                            Background="{ThemeResource LayerFillColorDefaultBrush}">
                                            <StackPanel Spacing="4">
                                                <TextBlock
                                                    Text="SỬ DỤNG"
                                                    FontSize="10"
                                                    FontWeight="Bold"
                                                    Foreground="{ThemeResource TextFillColorTertiaryBrush}" />
                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                    <TextBlock
                                                        Text="{Binding UsedCount}"
                                                        FontSize="18"
                                                        FontWeight="Bold" />
                                                    <TextBlock
                                                        Text="/"
                                                        FontSize="18"
                                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                                    <TextBlock
                                                        Text="{Binding UsageLimit}"
                                                        FontSize="18"
                                                        FontWeight="Bold" />
                                                </StackPanel>
                                            </StackPanel>
                                        </Border>
                                    </Grid>

                                    <!-- Date Range -->
                                    <StackPanel Spacing="6">
                                        <StackPanel Orientation="Horizontal" Spacing="6">
                                            <FontIcon
                                                Glyph="&#xE787;"
                                                FontSize="14"
                                                Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                            <TextBlock
                                                Text="Thời gian áp dụng"
                                                FontSize="12"
                                                FontWeight="SemiBold"
                                                Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                                        </StackPanel>
                                        <TextBlock
                                            Text="{Binding FormattedDateRange}"
                                            FontSize="14"
                                            TextWrapping="Wrap"
                                            LineHeight="20"
                                            Margin="20,0,0,0" />
                                    </StackPanel>

                                    <!-- Actions -->
                                    <Grid ColumnSpacing="10">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition />
                                            <ColumnDefinition />
                                        </Grid.ColumnDefinitions>

                                        <Button
                                            Content="Chỉnh sửa"
                                            HorizontalAlignment="Stretch"
                                            Padding="10,8"
                                            CornerRadius="8"
                                            FontWeight="SemiBold"
                                            Click="EditPromotion_Click" />

                                        <Button
                                            Grid.Column="1"
                                            Content="Hủy"
                                            HorizontalAlignment="Stretch"
                                            Padding="10,8"
                                            CornerRadius="8"
                                            FontWeight="SemiBold"
                                            Background="#FFE74C3C"
                                            Foreground="White"
                                            Click="CancelPromotion_Click"
                                            Visibility="{x:Bind statusBool, Mode=OneWay}">
                                            <Button.Resources>
                                                <SolidColorBrush x:Key="ButtonBackgroundPointerOver" Color="#FFC0392B"/>
                                            </Button.Resources>
                                        </Button>
                                    </Grid>
                                </StackPanel>
                            </Grid>
                        </Border>

                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </ScrollViewer>

    </Grid>
</Page>